function k(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}function l(a){if(!(a instanceof Array)){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];a=b?b.call(a):{next:k(a)};for(var c=[];!(b=a.next()).done;)c.push(b.value);a=c}return a}
var m="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)},n="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this;function p(a,b){if(b){var c=n;a=a.split(".");for(var e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&m(c,a,{configurable:!0,writable:!0,value:b})}}
p("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}});p("Array.prototype.includes",function(a){return a?a:function(b,c){var e=this;e instanceof String&&(e=String(e));var d=e.length;c=c||0;for(0>c&&(c=Math.max(c+d,0));c<d;c++){var f=e[c];if(f===b||Object.is(f,b))return!0}return!1}});
p("String.prototype.includes",function(a){return a?a:function(b,c){if(null==this)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return-1!==this.indexOf(b,c||0)}});function q(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(b.call(c,f,d,a))return{D:d,F:f}}return{D:-1,F:void 0}}
p("Array.prototype.find",function(a){return a?a:function(b,c){return q(this,b,c).F}});p("Array.prototype.findIndex",function(a){return a?a:function(b,c){return q(this,b,c).D}});
function r(a,b,c,e,d){this.a=a;this.text=void 0===b?"":b;this.x=void 0===c?.5:c;this.y=void 0===e?.5:e;this.u=void 0===d?"#ff0000":d;this.b=document.createElement("canvas");this.l=this.b.getContext("2d");this.i=this.c=null;this.f=0;this.onload=null;t(this);a=self.THREE;this.i=new a.Texture(this.b);b=this.b.width/8;this.c=new a.Mesh(new a.PlaneBufferGeometry(b,this.b.height/this.b.width*b),new a.MeshBasicMaterial({map:this.i,depthWrite:!1,depthTest:!1,transparent:!0}));this.i.needsUpdate=!0;this.c.renderOrder=
120;this.c.position.set(this.x,this.y,-100);this.a.THREE._camera.add(this.c);this.a.camera.render()}r.prototype.remove=function(){this.c&&this.c.parent&&this.c.parent.remove(this.c);delete this.c;delete this.l;delete this.b};
function t(a){var b=a.l;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;for(var c=a.text.split("\n"),e=0;e<c.length;e++)""!==c[e]&&c.splice.apply(c,[e,1].concat(l(u(a,c[e]))));a.f=0;c.forEach(function(f){a.f=Math.max(b.measureText(f).width,a.f)});a.b.width=a.f;a.b.height=50*c.length;var d=a.b.width/2;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;c.forEach(function(f,g){g=
50*(g+1)-50+38;b.strokeText(f,d,g);b.fillStyle=a.u;b.fillText(f,d,g)})}function u(a,b){b=b.split(" ");a=a.l;for(var c=b.length,e=null;0<=c&&!(e=b.slice(0,c),1==c||1024>a.measureText(e.join(" ")).width);c--);return[e,b.slice(c)].filter(function(d){return d&&d.length}).map(function(d){return d.join(" ")})};var v=self.THREE;
function x(a,b,c){var e=this;this.b=a;this.a=a.a;this.f=b;this.actions=c;this.j=!1;this.w=null;a=10*this.actions.length;this.c=new v.Mesh(new v.PlaneBufferGeometry(25,a+5),new v.MeshBasicMaterial({color:2236962,depthWrite:!1,depthTest:!1,transparent:!0,opacity:.5}));var d=a/2;this.actions.forEach(function(f){var g=new r(e.a,f,null,null,"#ff0000");g.c.position.y=d-5;g.c.position.z=-20;g.c.material.opacity=.75;e.c.add(g.c);d-=10;g.c.onclick=function(){y(e.b,e.f,f);e.close()}});this.c.renderOrder=119}
x.prototype.open=function(){if(!this.j){this.j=!0;this.b.h.g&&this.b.h.g.close();this.b.h.g=this;this.a.THREE.intersect=this.c.children;var a=this.a.THREE.getPosition(this.f.x+.05,this.f.y,75);this.c.position.set(a.x,a.y,a.z);this.c.lookAt(0,0,0);this.a.THREE._scene.add(this.c)}};x.prototype.close=function(){this.j&&(this.j=!1,this.b.h.g=null,this.a.THREE.intersect=null,this.a.THREE._scene.remove(this.c))};function z(a,b){this.h=a;this.a=b;this.b=this.i=null;this.f=[];this.A=[]}function A(a){fetch("/levels/"+a.a.id+".json").then(function(b){return b.json()}).then(function(b){a.i=b;b.dialog&&-1===a.h.C.indexOf(a.a.id)&&(B(a,b.dialog),a.h.C.push(a.a.id))});a.a.modules.markers&&(a.A=a.a.modules.markers.data);"UPbPS"==a.a.id&&a.a.THREE.embeds.add("https://b.micr.io/LzKWd/video/mario_1.mp4",.99,.51,.018,{J:!0,I:!0,H:!0})}
function B(a,b){b.forEach(function(c,e){a.f.push(setTimeout(function(){C(this,b[e],.5,.5)}.bind(a),3E3*e))})}function D(a,b,c,e){c&&(c=c.actions.filter(function(d){var f=a.h.s.items.map(function(g){return g.id});return(void 0==d.notInInventoryFilter||!f.includes(d.notInInventoryFilter))&&(void 0==d.inventoryFilter||f.includes(d.inventoryFilter))&&(null!=e&&e.includes(d.id)||null==e&&d.isDefault)}).map(function(d){return d.input}),b.o&&b.o.close(),b.o=new x(a,b,c),b.o.open())}
function y(a,b,c){var e=E(a,b.id),d=e&&e.actions.find(function(f){return f.input==c});null!=d&&("pick up"==d.input.toLowerCase()&&F(a.h.s,b),C(a,d.output,b.x,b.y),d["continue"]&&D(a,b,e,d["continue"]),d.navigateTo&&G(a.h,d.navigateTo))}function E(a,b){return a.i.items.find(function(c){return c.micrioId==b})}function C(a,b,c,e){a.b&&a.b.remove();b&&(a.b=new r(a.a,b,c,e),a.f.push(setTimeout(function(){this.b&&this.b.remove()}.bind(a),5E3)))};var H=document.createElement("canvas"),J=I(),K=J.height,L=J.width,M=J.scale,N=M*(J.B+J.padding);H.width=L*M;H.height=K*M;var O=H.getContext("2d"),P=window.THREE;
function Q(a){this.h=a;this.a=a.a;this.j=!1;this.f=new Audio;this.b=this.c=null;this.items=Array(20);a=L/K;this.b=new P.Texture(H);this.c=new P.Mesh(new P.PlaneBufferGeometry(10*a,10),new P.MeshBasicMaterial({map:this.b,color:16711680,depthWrite:!1,depthTest:!1,transparent:!0}));this.b.needsUpdate=!0;this.c.renderOrder=119;this.c.position.set(0,-8,-15)}function R(a){a.j=!0;a.a.THREE._camera.add(a.c);a.a.camera.render()}
function F(a,b){var c=a.items.findIndex(function(d){return!d});a.items[c]=b;if(b.title){var e=new r(a.a,"Picked up "+b.title,0,-12,"#00ff00");setTimeout(function(){return e.remove()},4E3)}b.audio&&b.audio.fileUrl&&(a.f.src=b.audio.fileUrl,a.f.play());b.remove();c=a.h.m.A.findIndex(function(d){return d.id==b.id});a.h.m.A.splice(c,1);b.v=b.images.map(function(d){var f=new Image;f.src=d.src.replace(/\.(jpg|png)/,".64.$1");f.crossOrigin="anonymous";return f});b.v[0]?b.v[0].onload=function(){S(a)}:S(a)}
function S(a){T(a);R(a);setTimeout(function(){a.j=!1;a.c.parent&&a.c.parent.remove(a.c)},4E3)}function T(a){O.clearRect(0,0,H.width,H.height);var b=I(),c=b.height,e=b.width,d=b.B,f=b.scale;b=b.padding;O.fillStyle="brown";O.fillRect(0,0,e*f,c*f);c=0;e=b*f;for(var g=0;g<a.items.length;g++){var w=a.items[g];c+=d*f+b*f;0==g%5&&(c=b*f,0!=g&&(e+=d*f+b*f));O.fillStyle="black";O.fillRect(c,e,d*f,d*f);w&&w.v[0]&&O.drawImage(w.v[0],c,e,d*f,d*f)}a.b.needsUpdate=!0}
function I(){return{width:104,height:84,B:16,padding:4,scale:4}};window.Micrio.prototype.forceGL=!0;function U(){var a=this;this.C=[];this.s=null;this.u={};this.b=this.a=this.g=this.m=null;this.create=this.create.bind(this);this.i=this.i.bind(this);this.l=this.l.bind(this);this.f=this.f.bind(this);document.fonts&&document.fonts.load?document.fonts.load('10pt "Acme"').then(function(){return a.create()}):this.create()}
U.prototype.create=function(){this.a=new window.Micrio({id:"UkwTz",forceGL:!0,fragmentShader:"\n\tvarying vec2 vUv;\n\n\tuniform float opacity;\n\tuniform sampler2D map;\n\n\tvec3 hsl2rgb(vec3 c)\n\t{\n\t\tfloat t = c.y * ((c.z < 0.5) ? c.z : (1.0 - c.z));\n\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\treturn (c.z + t) * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), 2.0*t / c.z);\n\t}\n\n\tvoid main(void)\n\t{\n\t\t/* Read a group of texels, doing a box blur */\n\n\t\tvec3 accumulator = vec3(0.0);\n\t\tvec2 dim_step = vec2(1.0/480.0) * 1.4;\n\n\t\tfor (int i = -2; i < 2; ++i) {\n\t\t\tfor (int j = -2; j < 2; ++j) {\n\t\t\t\taccumulator += texture2D(map, vUv + dim_step * vec2(i, j)).rgb;\n\t\t\t}\n\t\t}\n\n\t\tvec3 blur = accumulator / 16.0;\n\n\t\t/* Convert (RGB source) to greyscale luminance, by taking the Y\n\t\t * component of YUV (multiplying by BT.709 coefficients) */\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(blur, coefficients);\n\n\t\t/* Adjust brightness */\n\n\t\tfloat brightness = 1.1;\n\t\tgrey = clamp(grey * brightness, 0.0, 1.0);\n\n\t\t/* Posterize */\n\n\t\tfloat levels = (6.0) - 1.0;\n\t\tfloat posterized = floor((grey * levels) + 0.5) / levels;\n\n\t\t/* Increase contrast */\n\n\t\tfloat contrast = 1.4;\n\t\tfloat contrasted = clamp(contrast * (posterized - 0.5) + 0.5, 0.0, 1.0);\n\n\t\t/* Colourize! Choose a particular hue/saturation, and then pick colours\n\t\t * by setting the lightness to the calculated value above */\n\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 rgb = hsl2rgb(vec3(0.2, 0.4, contrasted));\n\t\tgl_FragColor = vec4(vec3(rgb), 1.0) * .09 + rgba * .93;\n\n\t\t//float darkness = .5 - (rgb.r+rgb.g+rgb.b)/3.;\n\n\t\t//gl_FragColor.rgb *= 1.-darkness;\n\n\t\tfloat grey2 = 0.21 * rgba.r + 0.71 * rgba.g + 0.07 * rgba.b;\n\n\t\tgl_FragColor.rgb *= .25 + .75 * grey2;\n\n\n\t\tgl_FragColor.a = opacity;\n\t}\n\n\t/*void mainx() {\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(coefficients, rgba.rgb);\n\n\t\tgl_FragColor = rgba;\n\t\tgl_FragColor.a = opacity;\n\t\tgl_FragColor.r += .5;\n\t}*/\n",minimap:!1,
loaderbar:!1,noToolbar:!0});this.b=this.a.container;this.b.addEventListener("click",this.onclick.bind(this));this.b.addEventListener("mousemove",this.G.bind(this));this.b.addEventListener("load",this.i)};U.prototype.i=function(){this.b.removeEventListener("load",this.i);this.b.addEventListener("metadata",this.l);this.s=new Q(this);this.l(this.a)};
U.prototype.l=function(a){a=this.a=a.detail?a.detail:a;if(this.m){var b=this.m;for(b.b&&b.b.remove();b.f.length;)clearTimeout(b.f.shift())}this.g&&this.g.close();this.u[a.id]||(this.u[a.id]=new z(this,a));this.m=this.u[this.a.id];this.a.THREE.onClickVR=this.f;A(this.m)};function G(a,b){a.g&&a.g.close();a.a.camera.stop();a.a.modules.navigator["goto"](b,void 0,!0)}
U.prototype.onclick=function(a){if(this.a&&this.a.THREE){if(this.g){var b=this.a.THREE.getCast([a.clientX,a.clientY],this.g.c.children)[0];if(b&&b.object.onclick){this.f(b);return}}if(this.s.j&&(b=this.a.THREE.getCast([a.clientX,a.clientY],[this.s.c])[0])){this.s.items[5*Math.floor((1-b.uv.y)*H.height/N)+Math.floor(b.uv.x*H.width/N)]&&console.log("use item!!");return}(a=this.a.THREE.getCast([a.clientX,a.clientY])[0])?this.f(a):this.g&&this.g.close()}};
U.prototype.f=function(a){if(a&&a.object)if(this.g&&a.object.onclick)a.object.onclick();else if(a=a.object.marker)if(a.link)a.open();else{var b=this.m,c=E(b,a.id);null!=c&&(a.o&&a.o.j?a.o.close():D(b,a,c,null))}};
U.prototype.G=function(a){if(this.a&&this.a.THREE){var b=this.a.THREE.getCast([a.clientX,a.clientY])[0];!b&&this.g&&(b=this.a.THREE.getCast([a.clientX,a.clientY],this.g.c.children)[0],b!=this.g.w&&(this.g.w&&(this.g.w.object.material.opacity=.75),b&&(b.object.material.opacity=1)),this.g.w=b,this.a.camera.render());a=b&&b.object.marker;var c=this.a.el.classList;a&&a.title?this.b.title=a.title:this.b.removeAttribute("title");b?c.contains("hover")||c.add("hover"):c.contains("hover")&&c.remove("hover")}};
window.h=new U;
