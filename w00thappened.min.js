/*
** W00t Happened!? -- https://www.w00thappened.com/
**
** A W00tcamp 2019 project https://w00t.camp/
**
** Made by Michiel, Dion, Lukas, Marieke, Yahya, Tim, Bas, Wendy, Marcel
**
** (C) Q42 Internet B.V. <https://q42.nl/>, Micrio <https://micr.io/>
** All Rights Reserved, 2019
**
*/
(function(){
'use strict';function g(a){const b=a.j;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;const c=a.text.split("\n");for(let d=0;d<c.length;d++)""!==c[d]&&c.splice.apply(c,[d,1,...k(a,c[d])]);a.f=0;c.forEach(d=>{a.f=Math.max(b.measureText(d).width,a.f)});a.b.width=a.f;a.b.height=50*c.length;const e=a.b.width/2;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;c.forEach((d,f)=>{f=
50*(f+1)-50+38;b.strokeText(d,e,f);b.fillStyle=a.s;b.fillText(d,e,f)})}function k(a,b){b=b.split(" ");a=a.j;let c=b.length,e=null;for(;0<=c&&!(e=b.slice(0,c),1==c||1024>a.measureText(e.join(" ")).width);c--);return[e,b.slice(c)].filter(d=>d&&d.length).map(d=>d.join(" "))}
class l{constructor(a,b="",c=.5,e=.5,d="#ff0000",f=!1,w=!0){this.a=a;this.text=b;this.x=c;this.y=e;this.s=d;this.w=f;this.D=w;this.b=document.createElement("canvas");this.j=this.b.getContext("2d");this.i=this.c=null;this.f=0;this.onload=null;g(this);a=self.THREE;this.i=new a.Texture(this.b);b=this.b.width/8;this.c=new a.Mesh(new a.PlaneBufferGeometry(b,this.b.height/this.b.width*b),new a.MeshBasicMaterial({map:this.i,depthWrite:!1,depthTest:!1,transparent:!0}));this.i.needsUpdate=!0;this.c.renderOrder=
120;this.D?(this.c.position.set(this.x,this.y,-100),this.a.THREE._camera.add(this.c),this.a.camera.render()):this.w||(a=this.a.THREE.getPosition(this.x,this.y,50),this.c.position.set(a.x,a.y,a.z),this.c.lookAt(0,0,0),this.a.THREE._scene.add(this.c),this.a.camera.render())}remove(){this.c&&this.c.parent&&this.c.parent.remove(this.c);delete this.c;delete this.j;delete this.b}};const m=self.THREE;
class n{constructor(a,b,c){this.b=a;this.a=a.a;this.f=b;this.actions=c;this.l=!1;this.v=null;a=10*this.actions.length;this.c=new m.Mesh(new m.PlaneBufferGeometry(25,a+5),new m.MeshBasicMaterial({color:2236962,depthWrite:!1,depthTest:!1,transparent:!0,opacity:.5}));let e=a/2;this.actions.forEach(d=>{const f=new l(this.a,d,null,null,"#ff0000",!0);f.c.position.y=e-5;f.c.position.z=-20;f.c.material.opacity=.75;this.c.add(f.c);e-=10;f.c.onclick=()=>{p(this.b,this.f,d);this.close()}});this.c.renderOrder=
119}open(){if(!this.l){this.l=!0;this.b.h.g&&this.b.h.g.close();this.b.h.g=this;this.a.THREE.intersect=this.c.children;var a=this.a.THREE.getPosition(this.f.x+.05,this.f.y,75);this.c.position.set(a.x,a.y,a.z);this.c.lookAt(0,0,0);this.a.THREE._scene.add(this.c)}}close(){this.l&&(this.l=!1,this.b.h.g=null,this.a.THREE.intersect=null,this.a.THREE._scene.remove(this.c))}};function p(a,b,c){const e=q(a,b.id),d=e&&e.actions.find(f=>f.input==c);null!=d&&("pick up"==d.input.toLowerCase()&&r(a.h.A,b),t(a,d.output,b.x,b.y),d["continue"]&&u(a,b,e,d["continue"]),d.navigateTo&&v(a.h,d.navigateTo))}
function x(a){fetch("/levels/"+a.a.id+".json").then(b=>b.json()).then(b=>{a.i=b;b.dialog&&-1===a.h.C.indexOf(a.a.id)&&(y(a,b.dialog),a.h.C.push(a.a.id))});a.a.modules.markers&&(a.B=a.a.modules.markers.data);"UPbPS"==a.a.id&&a.a.THREE.embeds.add("https://b.micr.io/LzKWd/video/mario_1.mp4",.99,.51,.018,{H:!0,G:!0,F:!0})}function y(a,b){b.forEach((c,e)=>{a.f.push(setTimeout(function(){t(this,b[e],.5,.5)}.bind(a),3E3*e))})}
function t(a,b,c,e){a.b&&a.b.remove();b&&(a.b=new l(a.a,b,c,e),a.f.push(setTimeout(function(){this.b&&this.b.remove()}.bind(a),5E3)))}function q(a,b){return a.i.items.find(c=>c.micrioId==b)}
function u(a,b,c,e){if(c){var d=a.h.A.items.map(f=>f.id);c=c.actions.filter(f=>(void 0==f.notInInventoryFilter||!d.includes(f.notInInventoryFilter))&&(void 0==f.inventoryFilter||d.includes(f.inventoryFilter))&&(null!=e&&e.includes(f.id)||null==e&&f.isDefault)).map(f=>f.input);b.o&&b.o.close();b.o=new n(a,b,c);b.o.open()}}class z{constructor(a,b){this.h=a;this.a=b;this.b=this.i=null;this.f=[];this.B=[]}};const A=document.createElement("canvas");A.width=416;A.height=336;const B=A.getContext("2d"),C=window.THREE;
function r(a,b){var c=a.items.findIndex(e=>!e);a.items[c]=b;if(b.title){const e=new l(a.a,"Picked up "+b.title,0,-12,"#00ff00");setTimeout(()=>e.remove(),4E3)}b.audio&&b.audio.fileUrl&&(a.f.src=b.audio.fileUrl,a.f.play());b.remove();c=a.h.m.B.findIndex(e=>e.id==b.id);a.h.m.B.splice(c,1);b.u=b.images.map(e=>{const d=new Image;d.src=e.src.replace(/\.(jpg|png)/,".64.$1");d.crossOrigin="anonymous";return d});b.u[0]?b.u[0].onload=()=>{D(a)}:D(a)}
function E(a){a.l=!0;a.a.THREE._camera.add(a.c);a.a.camera.render()}function D(a){F(a);E(a);setTimeout(()=>{a.l=!1;a.c.parent&&a.c.parent.remove(a.c)},4E3)}function F(a){B.clearRect(0,0,A.width,A.height);B.fillStyle="brown";B.fillRect(0,0,A.width,A.height);var b=0,c=16;for(let e=0;e<a.items.length;e++){const d=a.items[e];b+=80;0==e%5&&(b=16,0!=e&&(c+=80));B.fillStyle="black";B.fillRect(b,c,64,64);d&&d.u[0]&&B.drawImage(d.u[0],b,c,64,64)}a.b.needsUpdate=!0}
class G{constructor(a){this.h=a;this.a=a.a;this.l=!1;this.f=new Audio;this.b=this.c=null;this.items=Array(20);a=A.width/A.height;this.b=new C.Texture(A);this.c=new C.Mesh(new C.PlaneBufferGeometry(10*a,10),new C.MeshBasicMaterial({map:this.b,color:16711680,depthWrite:!1,depthTest:!1,transparent:!0}));this.b.needsUpdate=!0;this.c.renderOrder=119;this.c.position.set(0,-8,-15)}};window.Micrio.prototype.forceGL=!0;function v(a,b){a.g&&a.g.close();a.a.camera.stop();a.a.modules.navigator["goto"](b,void 0,!0)}
class H{constructor(){this.C=[];this.A=null;this.s={};this.b=this.a=this.g=this.m=null;this.create=this.create.bind(this);this.i=this.i.bind(this);this.j=this.j.bind(this);this.f=this.f.bind(this);document.fonts&&document.fonts.load?document.fonts.load('10pt "Acme"').then(()=>this.create()):this.create()}create(){this.a=new window.Micrio({id:"UkwTz",forceGL:!0,fragmentShader:"varying vec2 vUv; uniform float opacity; uniform sampler2D map;\nvec3 hsl2rgb(vec3 c)\n{\nfloat t = c.y * ((c.z < 0.5) ? c.z : (1.0 - c.z));\nvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\nreturn (c.z + t) * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), 2.0*t / c.z);\n}\nvoid main(void)\n{vec3 accumulator = vec3(0.0);\nvec2 dim_step = vec2(1.0/480.0) * 1.4;\n\nfor (int i = -2; i < 2; ++i) {\nfor (int j = -2; j < 2; ++j) {\naccumulator += texture2D(map, vUv + dim_step * vec2(i, j)).rgb;\n}\n}\n\nvec3 blur = accumulator / 16.0;vec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\nfloat grey = dot(blur, coefficients);float brightness = 1.1;\ngrey = clamp(grey * brightness, 0.0, 1.0);float levels = (6.0) - 1.0;\nfloat posterized = floor((grey * levels) + 0.5) / levels;float contrast = 1.4;\nfloat contrasted = clamp(contrast * (posterized - 0.5) + 0.5, 0.0, 1.0);vec4 rgba = texture2D(map, vUv);\n\nvec3 rgb = hsl2rgb(vec3(0.2, 0.4, contrasted));\ngl_FragColor = vec4(vec3(rgb), 1.0) * .09 + rgba * .93;float grey2 = 0.21 * rgba.r + 0.71 * rgba.g + 0.07 * rgba.b;\ngl_FragColor.rgb *= .25 + .75 * grey2;\ngl_FragColor.a = opacity;\n}",minimap:!1,
loaderbar:!1,noToolbar:!0});this.b=this.a.container;this.b.addEventListener("click",this.onclick.bind(this));this.b.addEventListener("mousemove",this.w.bind(this));this.b.addEventListener("load",this.i)}i(){this.b.removeEventListener("load",this.i);this.b.addEventListener("metadata",this.j);this.A=new G(this);this.j(this.a)}j(a){a=this.a=a.detail?a.detail:a;if(this.m){var b=this.m;for(b.b&&b.b.remove();b.f.length;)clearTimeout(b.f.shift())}this.g&&this.g.close();this.s[a.id]||(this.s[a.id]=new z(this,
a));this.m=this.s[this.a.id];this.a.THREE.onClickVR=this.f;x(this.m)}onclick(a){if(this.a&&this.a.THREE){if(this.g){const b=this.a.THREE.getCast([a.clientX,a.clientY],this.g.c.children)[0];if(b&&b.object.onclick){this.f(b);return}}(a=this.a.THREE.getCast([a.clientX,a.clientY])[0])?this.f(a):this.g&&this.g.close()}}f(a){if(a&&a.object)if(this.g&&a.object.onclick)a.object.onclick();else if(a=a.object.marker)if(a.link)a.open();else{{var b=this.m;const c=q(b,a.id);null!=c&&(a.o&&a.o.l?a.o.close():u(b,
a,c,null))}}}w(a){if(this.a&&this.a.THREE){var b=this.a.THREE.getCast([a.clientX,a.clientY])[0];!b&&this.g&&(b=this.a.THREE.getCast([a.clientX,a.clientY],this.g.c.children)[0],b!=this.g.v&&(this.g.v&&(this.g.v.object.material.opacity=.75),b&&(b.object.material.opacity=1)),this.g.v=b,this.a.camera.render());a=b&&b.object.marker;var c=this.a.el.classList;a&&a.title?this.b.title=a.title:this.b.removeAttribute("title");b?c.contains("hover")||c.add("hover"):c.contains("hover")&&c.remove("hover")}}}
window.h=new H;
})()
