var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).i}},"es6","es3");
var Text$$module$js$text=function(a,b,c,d,e,f,g){this.micrio=a;this.text=void 0===b?"":b;this.x=void 0===c?.5:c;this.y=void 0===d?.5:d;this.color=void 0===e?"#ff0000":e;this.independent=void 0===f?!1:f;this.static=void 0===g?!0:g;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.texture=this.mesh=null;this.measuredWidth=0;this.onload=null;this.drawCanvas();this.place()};
Text$$module$js$text.prototype.place=function(){var a=self.THREE;this.texture=new a.Texture(this.canvas);var b=this.canvas.width/8;this.mesh=new a.Mesh(new a.PlaneBufferGeometry(b,this.canvas.height/this.canvas.width*b),new a.MeshBasicMaterial({map:this.texture,depthWrite:!1,depthTest:!1,transparent:!0}));this.texture.needsUpdate=!0;this.mesh.renderOrder=120;this.static?(this.mesh.position.set(this.x,this.y,-100),this.micrio.THREE._camera.add(this.mesh),this.micrio.camera.render()):this.independent||
(a=this.micrio.THREE.getPosition(this.x,this.y,50),this.mesh.position.set(a.x,a.y,a.z),this.mesh.lookAt(0,0,0),this.micrio.THREE._scene.add(this.mesh),this.micrio.camera.render())};Text$$module$js$text.prototype.remove=function(){this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh);delete this.mesh;delete this.ctx;delete this.canvas};
Text$$module$js$text.prototype.drawCanvas=function(){var a=this,b=this.ctx;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;for(var c=this.text.split("\n"),d=0;d<c.length;d++)""!==c[d]&&c.splice.apply(c,[d,1].concat($jscomp.arrayFromIterable(this.resizeLine(c[d]))));this.measuredWidth=0;c.forEach(function(c){a.measuredWidth=Math.max(b.measureText(c).width,a.measuredWidth)});this.canvas.width=this.measuredWidth;this.canvas.height=50*c.length;
var e=this.canvas.width/2;b.font="normal 600 38px / 50px Acme";b.textAlign="center";b.strokeStyle="#000000";b.lineWidth=8;b.miterLimit=2;c.forEach(function(c,d){d=50*(d+1)-50+38;b.strokeText(c,e,d);b.fillStyle=a.color;b.fillText(c,e,d)})};Text$$module$js$text.prototype.resizeLine=function(a){a=a.split(" ");for(var b=this.ctx,c=a.length,d=null;0<=c&&!(d=a.slice(0,c),1==c||1024>b.measureText(d.join(" ")).width);c--);return[d,a.slice(c)].filter(function(a){return a&&a.length}).map(function(a){return a.join(" ")})};
var module$js$text={};module$js$text.default=Text$$module$js$text;var THREE$$module$js$action=self.THREE,ActionPopup$$module$js$action=function(a,b,c){var d=this;this.level=a;this.micrio=a.micrio;this.item=b;this.actions=c;this.opened=!1;this.hovered=null;a=10*this.actions.length;this.mesh=new THREE$$module$js$action.Mesh(new THREE$$module$js$action.PlaneBufferGeometry(25,a+5),new THREE$$module$js$action.MeshBasicMaterial({color:2236962,depthWrite:!1,depthTest:!1,transparent:!0,opacity:.5}));var e=a/2;this.actions.forEach(function(a){var b=new Text$$module$js$text(d.micrio,
a,null,null,"#ff0000",!0);b.mesh.position.y=e-5;b.mesh.position.z=-20;b.mesh.material.opacity=.75;d.mesh.add(b.mesh);e-=10;b.mesh.onclick=function(){d.level.actionItem(d.item,a);d.close()}});this.mesh.renderOrder=119};ActionPopup$$module$js$action.prototype.toggle=function(){this.opened?this.close():this.open()};
ActionPopup$$module$js$action.prototype.open=function(){if(!this.opened){this.opened=!0;this.level.game.currentPopup&&this.level.game.currentPopup.close();this.level.game.currentPopup=this;this.micrio.THREE.intersect=this.mesh.children;var a=this.micrio.THREE.getPosition(this.item.x+.05,this.item.y,75);this.mesh.position.set(a.x,a.y,a.z);this.mesh.lookAt(0,0,0);this.micrio.THREE._scene.add(this.mesh)}};
ActionPopup$$module$js$action.prototype.close=function(){this.opened&&(this.opened=!1,this.level.game.currentPopup=null,this.micrio.THREE.intersect=null,this.micrio.THREE._scene.remove(this.mesh))};var module$js$action={};module$js$action.default=ActionPopup$$module$js$action;var Level$$module$js$level=function(a,b){this.game=a;this.micrio=b;this.lastText=this.level=null;this.tos=[]};Level$$module$js$level.prototype.activate=function(){var a=this;fetch("/levels/"+this.micrio.id+".json").then(function(a){return a.json()}).then(function(b){return a.startLevel(b)});"UPbPS"==this.micrio.id&&this.micrio.THREE.embeds.add("https://b.micr.io/LzKWd/video/mario_1.mp4",.99,.51,.018,{isVideo:!0,greenScreen:!0,fade:!0})};
Level$$module$js$level.prototype.startLevel=function(a){this.level=a;a.dialog&&-1===this.game.hasPlayedIntroTexts.indexOf(this.micrio.id)&&(this.showDialog(a.dialog),this.game.hasPlayedIntroTexts.push(this.micrio.id))};Level$$module$js$level.prototype.showDialog=function(a){a.forEach(function(b,c){this.tos.push(setTimeout(function(){this.printText(a[c],.5,.5)}.bind(this),3E3*c))}.bind(this))};
Level$$module$js$level.prototype.clickedItem=function(a){var b=this.getItemForId(a.id);null!=b&&(a._actions&&a._actions.opened?a._actions.close():this.renderActionOptions(a,b,null))};
Level$$module$js$level.prototype.renderActionOptions=function(a,b,c){null!=b&&(b=b.actions.filter(function(a){var b=this.game.inventory.items.map(function(a){return a.id});return(void 0==a.notInInventoryFilter||!b.includes(a.notInInventoryFilter))&&(void 0==a.inventoryFilter||b.includes(a.inventoryFilter))&&(null!=c&&c.includes(a.id)||null==c&&a.isDefault)}.bind(this)).map(function(a){return a.input}),a._actions&&a._actions.close(),a._actions=new ActionPopup$$module$js$action(this,a,b),a._actions.open())};
Level$$module$js$level.prototype.actionItem=function(a,b){var c=this.getItemForId(a.id),d=c&&c.actions.find(function(a){return a.input==b});null!=d&&(b=c.actions.find(function(a){return a.input==b}),null!=b&&"pick up"==b.input.toLowerCase()&&this.game.inventory.addItem(a),this.printText(b.output,a.x,a.y),d.continue&&this.renderActionOptions(a,c,b.continue),d.navigateTo&&this.game.goto(d.navigateTo))};
Level$$module$js$level.prototype.getItemForId=function(a){return this.level.items.find(function(b){return b.micrioId==a})};Level$$module$js$level.prototype.printText=function(a,b,c){this.lastText&&this.lastText.remove();a&&(this.lastText=new Text$$module$js$text(this.micrio,a,b,c),this.tos.push(setTimeout(function(){this.lastText&&this.lastText.remove()}.bind(this),5E3)))};Level$$module$js$level.prototype.deactivate=function(){for(this.lastText&&this.lastText.remove();this.tos.length;)clearTimeout(this.tos.shift())};
var module$js$level={};module$js$level.default=Level$$module$js$level;var canvas$$module$js$inventory=document.createElement("canvas"),size$$module$js$inventory=drawSize$$module$js$inventory(),height$$module$js$inventory=size$$module$js$inventory.height,width$$module$js$inventory=size$$module$js$inventory.width,scale$$module$js$inventory=size$$module$js$inventory.scale,boxSize$$module$js$inventory=scale$$module$js$inventory*(size$$module$js$inventory.boxSize+size$$module$js$inventory.padding);canvas$$module$js$inventory.width=width$$module$js$inventory*scale$$module$js$inventory;
canvas$$module$js$inventory.height=height$$module$js$inventory*scale$$module$js$inventory;var ctx$$module$js$inventory=canvas$$module$js$inventory.getContext("2d"),THREE$$module$js$inventory=window.THREE,Inventory$$module$js$inventory=function(a){this.game=a;this.micrio=a.micrio;this.opened=!1;this._audio=new Audio;this.inventorySize=20;this.items=Array(this.inventorySize);this.init()};
Inventory$$module$js$inventory.prototype.init=function(){var a=width$$module$js$inventory/height$$module$js$inventory;this.texture=new THREE$$module$js$inventory.Texture(canvas$$module$js$inventory);this.mesh=new THREE$$module$js$inventory.Mesh(new THREE$$module$js$inventory.PlaneBufferGeometry(10*a,10),new THREE$$module$js$inventory.MeshBasicMaterial({map:this.texture,color:16711680,depthWrite:!1,depthTest:!1,transparent:!0}));this.texture.needsUpdate=!0;this.mesh.renderOrder=119;this.mesh.position.set(0,
-8,-15)};Inventory$$module$js$inventory.prototype.show=function(){this.opened=!0;this.micrio.THREE._camera.add(this.mesh);this.micrio.camera.render()};Inventory$$module$js$inventory.prototype.hide=function(){this.opened=!1;this.mesh.parent&&this.mesh.parent.remove(this.mesh)};
Inventory$$module$js$inventory.prototype.clicked=function(a,b){this.items[5*Math.floor(b*canvas$$module$js$inventory.height/boxSize$$module$js$inventory)+Math.floor(a*canvas$$module$js$inventory.width/boxSize$$module$js$inventory)]&&console.log("use item!!")};
Inventory$$module$js$inventory.prototype.addItem=function(a){var b=this,c=this.items.findIndex(function(a){return!a});this.items[c]=a;if(a.title){var d=new Text$$module$js$text(this.micrio,"Picked up "+a.title,0,-12,"#00ff00");setTimeout(function(){return d.remove()},4E3)}a.audio&&a.audio.fileUrl&&(this._audio.src=a.audio.fileUrl,this._audio.play());a.remove();a._images=a.images.map(function(a){var b=new Image;b.src=a.src.replace(/\.(jpg|png)/,".64.$1");b.crossOrigin=!0;return b});a._images[0]?a._images[0].onload=
function(){b.showHide()}:this.showHide()};Inventory$$module$js$inventory.prototype.showHide=function(){var a=this;this.draw();this.show();setTimeout(function(){return a.hide()},4E3)};Inventory$$module$js$inventory.prototype.removeItem=function(a){var b=this.items.findIndex(function(b){return b.id==a});0<=b&&(this.items.splice(b,1),this.draw())};
Inventory$$module$js$inventory.prototype.draw=function(){ctx$$module$js$inventory.clearRect(0,0,canvas$$module$js$inventory.width,canvas$$module$js$inventory.height);var a=drawSize$$module$js$inventory(),b=a.height,c=a.width,d=a.boxSize,e=a.scale;a=a.padding;ctx$$module$js$inventory.fillStyle="brown";ctx$$module$js$inventory.fillRect(0,0,c*e,b*e);b=0;c=a*e;for(var f=0;f<this.items.length;f++){var g=this.items[f];b+=d*e+a*e;0==f%5&&(b=a*e,0!=f&&(c+=d*e+a*e));ctx$$module$js$inventory.fillStyle="black";
ctx$$module$js$inventory.fillRect(b,c,d*e,d*e);g&&g._images[0]&&ctx$$module$js$inventory.drawImage(g._images[0],b,c,d*e,d*e)}this.texture.needsUpdate=!0};
Inventory$$module$js$inventory.prototype.drawItemInspect=function(a){ctx$$module$js$inventory.clearRect(0,0,canvas$$module$js$inventory.width,canvas$$module$js$inventory.height);var b=drawSize$$module$js$inventory(),c=b.height,d=b.width,e=b.scale,f=b.padding;ctx$$module$js$inventory.fillStyle="brown";ctx$$module$js$inventory.fillRect(f*e,f*e,d/2*e,c*e-2*f*e);var g=new Image;g.src=a[this.ItemProperties.popupSprite];console.log(d,c);g.onload=function(){ctx$$module$js$inventory.drawImage(g,f*e,f*e,d/
2*e,c*e-2*f*e)}};function drawSize$$module$js$inventory(){return{width:104,height:84,boxSize:16,padding:4,scale:4}}var module$js$inventory={};module$js$inventory.default=Inventory$$module$js$inventory;var fragmentShader$$module$js$shader="\n\tvarying vec2 vUv;\n\n\tuniform float opacity;\n\tuniform sampler2D map;\n\n\tvec3 hsl2rgb(vec3 c)\n\t{\n\t\tfloat t = c.y * ((c.z < 0.5) ? c.z : (1.0 - c.z));\n\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\treturn (c.z + t) * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), 2.0*t / c.z);\n\t}\n\n\tvoid main(void)\n\t{\n\t\t/* Read a group of texels, doing a box blur */\n\n\t\tvec3 accumulator = vec3(0.0);\n\t\tvec2 dim_step = vec2(1.0/480.0) * 1.4;\n\n\t\tfor (int i = -2; i < 2; ++i) {\n\t\t\tfor (int j = -2; j < 2; ++j) {\n\t\t\t\taccumulator += texture2D(map, vUv + dim_step * vec2(i, j)).rgb;\n\t\t\t}\n\t\t}\n\n\t\tvec3 blur = accumulator / 16.0;\n\n\t\t/* Convert (RGB source) to greyscale luminance, by taking the Y\n\t\t * component of YUV (multiplying by BT.709 coefficients) */\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(blur, coefficients);\n\n\t\t/* Adjust brightness */\n\n\t\tfloat brightness = 1.1;\n\t\tgrey = clamp(grey * brightness, 0.0, 1.0);\n\n\t\t/* Posterize */\n\n\t\tfloat levels = (6.0) - 1.0;\n\t\tfloat posterized = floor((grey * levels) + 0.5) / levels;\n\n\t\t/* Increase contrast */\n\n\t\tfloat contrast = 1.4;\n\t\tfloat contrasted = clamp(contrast * (posterized - 0.5) + 0.5, 0.0, 1.0);\n\n\t\t/* Colourize! Choose a particular hue/saturation, and then pick colours\n\t\t * by setting the lightness to the calculated value above */\n\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 rgb = hsl2rgb(vec3(0.2, 0.4, contrasted));\n\t\tgl_FragColor = vec4(vec3(rgb), 1.0) * .09 + rgba * .93;\n\n\t\t//float darkness = .5 - (rgb.r+rgb.g+rgb.b)/3.;\n\n\t\t//gl_FragColor.rgb *= 1.-darkness;\n\n\t\tfloat grey2 = 0.21 * rgba.r + 0.71 * rgba.g + 0.07 * rgba.b;\n\n\t\tgl_FragColor.rgb *= .25 + .75 * grey2;\n\n\n\t\tgl_FragColor.a = opacity;\n\t}\n\n\t/*void mainx() {\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(coefficients, rgba.rgb);\n\n\t\tgl_FragColor = rgba;\n\t\tgl_FragColor.a = opacity;\n\t\tgl_FragColor.r += .5;\n\t}*/\n",
module$js$shader={fragmentShader:fragmentShader$$module$js$shader};window.Micrio.prototype.forceGL=!0;var Game$$module$js$game=function(){this.hasPlayedIntroTexts=[];this.inventory=null;this.levels={};this._container=this.micrio=this.currentPopup=this.currentLevel=null;this.create=this.create.bind(this);this.init=this.init.bind(this);this.setLevel=this.setLevel.bind(this);this.onclicked=this.onclicked.bind(this);document.fonts&&document.fonts.load?document.fonts.load('10pt "Acme"').then(this.create):this.create()};
Game$$module$js$game.prototype.create=function(){this.micrio=new window.Micrio({id:"UkwTz",forceGL:!0,fragmentShader:fragmentShader$$module$js$shader,minimap:!1,loaderbar:!1,noToolbar:!0});this._container=this.micrio.container;this._container.addEventListener("click",this.onclick.bind(this));this._container.addEventListener("mousemove",this.mousemove.bind(this));this._container.addEventListener("load",this.init)};
Game$$module$js$game.prototype.init=function(){this._container.removeEventListener("load",this.init);this._container.addEventListener("metadata",this.setLevel);this._container.addEventListener("pre-metadata",this.setShader);this.inventory=new Inventory$$module$js$inventory(this);this.setLevel(this.micrio)};
Game$$module$js$game.prototype.setLevel=function(a){a=this.micrio=a.detail?a.detail:a;this.currentLevel&&this.currentLevel.deactivate();this.currentPopup&&this.currentPopup.close();this.levels[a.id]||(this.levels[a.id]=new Level$$module$js$level(this,a));this.currentLevel=this.levels[this.micrio.id];this.micrio.THREE.onClickVR=this.onclicked;this.currentLevel.activate()};
Game$$module$js$game.prototype.goto=function(a){this.currentPopup&&this.currentPopup.close();this.micrio.camera.stop();this.micrio.modules.navigator.goto(a,void 0,!0)};Game$$module$js$game.prototype.saveGame=function(){};Game$$module$js$game.prototype.loadGame=function(){};
Game$$module$js$game.prototype.onclick=function(a){if(this.micrio&&this.micrio.THREE){if(this.currentPopup){var b=this.micrio.THREE.getCast([a.clientX,a.clientY],this.currentPopup.mesh.children)[0];if(b&&b.object.onclick){this.onclicked(b);return}}if(this.inventory.opened&&(b=this.micrio.THREE.getCast([a.clientX,a.clientY],[this.inventory.mesh])[0])){this.inventory.clicked(b.uv.x,1-b.uv.y);return}if(a=this.micrio.THREE.getCast([a.clientX,a.clientY])[0])this.onclicked(a);else this.currentPopup&&this.currentPopup.close()}};
Game$$module$js$game.prototype.onclicked=function(a){if(a&&a.object)if(this.currentPopup&&a.object.onclick)a.object.onclick();else(a=a.object.marker)&&(a.link?a.open():this.currentLevel.clickedItem(a))};
Game$$module$js$game.prototype.mousemove=function(a){if(this.micrio&&this.micrio.THREE){var b=this.micrio.THREE.getCast([a.clientX,a.clientY])[0];!b&&this.currentPopup&&(b=this.micrio.THREE.getCast([a.clientX,a.clientY],this.currentPopup.mesh.children)[0],b!=this.currentPopup.hovered&&(this.currentPopup.hovered&&(this.currentPopup.hovered.object.material.opacity=.75),b&&(b.object.material.opacity=1)),this.currentPopup.hovered=b,this.micrio.camera.render());a=b&&b.object.marker;var c=this.micrio.el.classList;
this._container.title=a&&a.title||"";b?c.contains("hover")||c.add("hover"):c.contains("hover")&&c.remove("hover")}};window.game=new Game$$module$js$game;var module$js$game={};module$js$game.default=Game$$module$js$game;
