var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,e){if(b){c=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in c||(c[d]={});c=c[d]}a=a[a.length-1];e=c[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var d=b.length;c=c||0;for(0>c&&(c=Math.max(c+d,0));c<d;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var f=a[d];if(b.call(c,f,d,a))return{i:d,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).i}},"es6","es3");var canvas$$module$js$text=document.createElement("canvas");
canvas$$module$js$text.width=1024;canvas$$module$js$text.height=512;
var ctx$$module$js$text=canvas$$module$js$text.getContext("2d"),Text$$module$js$text=function(a,b,c,e,d,f,g){this.micrio=a;this.text=void 0===b?"":b;this.x=void 0===c?.5:c;this.y=void 0===e?.5:e;this.color=void 0===d?"#ff0000":d;this.independent=void 0===f?!1:f;this.static=void 0===g?!0:g;this.texture=this.mesh=null;this.src=this.drawCanvas();this.image=new Image;this.image.onload=this.place.bind(this);this.image.src=this.src;this.onload=null};
Text$$module$js$text.prototype.place=function(){var a=self.THREE;this.texture=new a.Texture(this.image);this.mesh=new a.Mesh(new a.PlaneBufferGeometry(100,canvas$$module$js$text.height/canvas$$module$js$text.width*100),new a.MeshBasicMaterial({map:this.texture,depthWrite:!1,depthTest:!1,transparent:!0}));this.texture.needsUpdate=!0;this.mesh.renderOrder=120;this.static?(this.mesh.position.set(this.x,this.y,-100),this.micrio.THREE._camera.add(this.mesh),this.micrio.camera.render()):this.independent||
(a=this.micrio.THREE.getPosition(this.x,this.y,50),this.mesh.position.set(a.x,a.y,a.z),this.mesh.lookAt(0,0,0),this.micrio.THREE._scene.add(this.mesh),this.micrio.camera.render());if(this.onload)this.onload()};Text$$module$js$text.prototype.remove=function(){this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh)};
Text$$module$js$text.prototype.drawCanvas=function(){var a=this,b=canvas$$module$js$text.width/1024,c=38*b,e=50*b;b="normal 600 "+c+"px / "+e+"px Acme";for(var d=this.text.split("\n"),f=0;f<d.length;f++)""!==d[f]&&d.splice.apply(d,[f,1].concat($jscomp.arrayFromIterable(this.resizeLine(d[f]))));var g=canvas$$module$js$text.width/2;canvas$$module$js$text.height=e*d.length;ctx$$module$js$text.font=b;ctx$$module$js$text.textAlign="center";ctx$$module$js$text.strokeStyle="#000000";ctx$$module$js$text.lineWidth=
8;ctx$$module$js$text.miterLimit=2;d.forEach(function(b,d){d=(d+1)*e-e+c;ctx$$module$js$text.strokeText(b,g,d);ctx$$module$js$text.fillStyle=a.color;ctx$$module$js$text.fillText(b,g,d)});return canvas$$module$js$text.toDataURL()};Text$$module$js$text.prototype.resizeLine=function(a){a=a.split(" ");for(var b=a.length,c=null;0<=b&&!(c=a.slice(0,b),1==b||ctx$$module$js$text.measureText(c.join(" ")).width<canvas$$module$js$text.width-60);b--);return[c,a.slice(b)].filter(function(a){return a&&a.length}).map(function(a){return a.join(" ")})};
var module$js$text={};module$js$text.default=Text$$module$js$text;var THREE$$module$js$action=self.THREE,ActionPopup$$module$js$action=function(a,b,c){var e=this;this.level=a;this.micrio=a.micrio;this.item=b;this.actions=c;this.opened=!1;this.hovered=null;a=10*this.actions.length;this.mesh=new THREE$$module$js$action.Mesh(new THREE$$module$js$action.PlaneBufferGeometry(25,a+5),new THREE$$module$js$action.MeshBasicMaterial({color:2236962,depthWrite:!1,depthTest:!1,transparent:!0,opacity:.5}));var d=a/2;this.actions.forEach(function(a){var b=new Text$$module$js$text(e.micrio,
a,null,null,"#ff0000",!0);b.onload=function(){b.mesh.position.y=d-5;b.mesh.position.z=-10;b.mesh.material.opacity=.75;e.mesh.add(b.mesh);d-=10;b.mesh.onclick=function(){e.level.actionItem(e.item,a);e.close()}}});this.mesh.renderOrder=119};ActionPopup$$module$js$action.prototype.toggle=function(){this.opened?this.close():this.open()};
ActionPopup$$module$js$action.prototype.open=function(){if(!this.opened){this.opened=!0;this.level.game.currentPopup&&this.level.game.currentPopup.close();this.level.game.currentPopup=this;this.micrio.THREE.intersect=this.mesh.children;var a=this.micrio.THREE.getPosition(this.item.x+.05,this.item.y,75);this.mesh.position.set(a.x,a.y,a.z);this.mesh.lookAt(0,0,0);this.micrio.THREE._scene.add(this.mesh);this.micrio.camera.render()}};
ActionPopup$$module$js$action.prototype.close=function(){this.opened&&(this.opened=!1,this.level.game.currentPopup=null,this.micrio.THREE.intersect=null,this.micrio.THREE._scene.remove(this.mesh),this.micrio.camera.render())};var module$js$action={};module$js$action.default=ActionPopup$$module$js$action;var Level$$module$js$level=function(a,b){this.game=a;this.micrio=b;this.lastText=this.level=null;this.tos=[]};Level$$module$js$level.prototype.activate=function(){var a=this;console.log("Activate level",this.micrio.id);fetch("/levels/"+this.micrio.id+".json").then(function(a){return a.json()}).then(function(b){return a.startLevel(b)});"UPbPS"==this.micrio.id&&this.micrio.THREE.embeds.add("https://b.micr.io/LzKWd/video/mario_1.mp4",.99,.51,.018,{isVideo:!0,greenScreen:!0,fade:!0})};
Level$$module$js$level.prototype.startLevel=function(a){console.log("Start level:"+a.name);this.level=a;a.dialog&&-1===this.game.hasPlayedIntroTexts.indexOf(this.micrio.id)&&(this.showDialog(a.dialog),this.game.hasPlayedIntroTexts.push(this.micrio.id))};Level$$module$js$level.prototype.showDialog=function(a){console.log("start dialog");a.forEach(function(b,c){this.tos.push(setTimeout(function(){console.log(a[c]);this.printText(a[c],.5,.5)}.bind(this),3E3*c))}.bind(this))};
Level$$module$js$level.prototype.clickedItem=function(a){console.log("clicked on item!",a.id);var b=this.getItemForId(a.id);null!=b&&this.renderActionOptions(a,b,null)};
Level$$module$js$level.prototype.renderActionOptions=function(a,b,c){null!=b&&(b=b.actions.filter(function(a){var b=this.game.inventory.items.map(function(a){return a.id});return(void 0==a.inventoryFilter||b.includes(a.inventoryFilter))&&(null!=c&&c.includes(a.id)||null==c&&a.isDefault)}.bind(this)).map(function(a){return a.input}),console.log("Render replies",b),a._actions&&a._actions.close(),a._actions=new ActionPopup$$module$js$action(this,a,b),a._actions.toggle())};
Level$$module$js$level.prototype.actionItem=function(a,b){console.log("action item!",b,a);var c=this.getItemForId(a.id),e=c&&c.actions.find(function(a){return a.input==b});null!=e&&(b=c.actions.find(function(a){return a.input==b}),null!=b&&(console.log("Selected action",b),"pick up"==b.input.toLowerCase()&&this.game.inventory.addItem(a)),this.printText(b.output,a.x,a.y),e.continue&&this.renderActionOptions(a,c,b.continue),e.navigateTo&&this.game.goto(e.navigateTo))};
Level$$module$js$level.prototype.getItemForId=function(a){return this.level.items.find(function(b){return b.micrioId==a})};Level$$module$js$level.prototype.printText=function(a,b,c){this.lastText&&this.lastText.remove();this.lastText=new Text$$module$js$text(this.micrio,a,b,c);this.tos.push(setTimeout(function(){this.lastText&&this.lastText.remove()}.bind(this),5E3))};Level$$module$js$level.prototype.deactivate=function(){console.log("Deactivate level",this.micrio.id);for(this.lastText&&this.lastText.remove();this.tos.length;)clearTimeout(this.tos.shift())};
var module$js$level={};module$js$level.default=Level$$module$js$level;var canvas$$module$js$inventory=document.createElement("canvas"),size$$module$js$inventory=drawSize$$module$js$inventory(),height$$module$js$inventory=size$$module$js$inventory.height,width$$module$js$inventory=size$$module$js$inventory.width,scale$$module$js$inventory=size$$module$js$inventory.scale,boxSize$$module$js$inventory=scale$$module$js$inventory*(size$$module$js$inventory.boxSize+size$$module$js$inventory.padding);canvas$$module$js$inventory.width=width$$module$js$inventory*scale$$module$js$inventory;
canvas$$module$js$inventory.height=height$$module$js$inventory*scale$$module$js$inventory;var ctx$$module$js$inventory=canvas$$module$js$inventory.getContext("2d"),THREE$$module$js$inventory=window.THREE,Inventory$$module$js$inventory=function(a){this.game=a;this.micrio=a.micrio;this.opened=!1;this._audio=new Audio;this.inventorySize=20;this.items=Array(this.inventorySize);this.init()};
Inventory$$module$js$inventory.prototype.init=function(){var a=width$$module$js$inventory/height$$module$js$inventory;this.texture=new THREE$$module$js$inventory.Texture(canvas$$module$js$inventory);this.mesh=new THREE$$module$js$inventory.Mesh(new THREE$$module$js$inventory.PlaneBufferGeometry(10*a,10),new THREE$$module$js$inventory.MeshBasicMaterial({map:this.texture,color:16711680,depthWrite:!1,depthTest:!1,transparent:!0}));this.texture.needsUpdate=!0;this.mesh.renderOrder=119;this.mesh.position.set(0,
-5,-15)};Inventory$$module$js$inventory.prototype.show=function(){this.opened=!0;this.micrio.THREE._camera.add(this.mesh);this.micrio.camera.render()};Inventory$$module$js$inventory.prototype.hide=function(){this.opened=!1;this.mesh.parent&&this.mesh.parent.remove(this.mesh)};
Inventory$$module$js$inventory.prototype.clicked=function(a,b){this.items[5*Math.floor(b*canvas$$module$js$inventory.height/boxSize$$module$js$inventory)+Math.floor(a*canvas$$module$js$inventory.width/boxSize$$module$js$inventory)]&&console.log("use item!!")};
Inventory$$module$js$inventory.prototype.addItem=function(a){var b=this,c=this.items.findIndex(function(a){return!a});this.items[c]=a;if(a.title){var e=new Text$$module$js$text(this.micrio,"Picked up "+a.title,0,5,"#00ff00");setTimeout(function(){return e.remove()},4E3)}a.audio&&a.audio.fileUrl&&(this._audio.src=a.audio.fileUrl,this._audio.play());a.remove();a._images=a.images.map(function(a){var b=new Image;b.src=a.src.replace(/\.(jpg|png)/,".64.$1");b.crossOrigin=!0;return b});a._images[0]?a._images[0].onload=
function(){b.showHide()}:this.showHide()};Inventory$$module$js$inventory.prototype.showHide=function(){var a=this;this.draw();this.show();setTimeout(function(){return a.hide()},4E3)};Inventory$$module$js$inventory.prototype.removeItem=function(a){var b=this.items.findIndex(function(b){return b.id==a});0<=b&&(this.items.splice(b,1),this.draw())};
Inventory$$module$js$inventory.prototype.draw=function(){ctx$$module$js$inventory.clearRect(0,0,canvas$$module$js$inventory.width,canvas$$module$js$inventory.height);var a=drawSize$$module$js$inventory(),b=a.height,c=a.width,e=a.boxSize,d=a.scale;a=a.padding;ctx$$module$js$inventory.fillStyle="brown";ctx$$module$js$inventory.fillRect(0,0,c*d,b*d);b=0;c=a*d;for(var f=0;f<this.items.length;f++){var g=this.items[f];b+=e*d+a*d;0==f%5&&(b=a*d,0!=f&&(c+=e*d+a*d));ctx$$module$js$inventory.fillStyle="black";
ctx$$module$js$inventory.fillRect(b,c,e*d,e*d);g&&g._images[0]&&ctx$$module$js$inventory.drawImage(g._images[0],b,c,e*d,e*d)}this.texture.needsUpdate=!0};
Inventory$$module$js$inventory.prototype.drawItemInspect=function(a){ctx$$module$js$inventory.clearRect(0,0,canvas$$module$js$inventory.width,canvas$$module$js$inventory.height);var b=drawSize$$module$js$inventory(),c=b.height,e=b.width,d=b.scale,f=b.padding;ctx$$module$js$inventory.fillStyle="brown";ctx$$module$js$inventory.fillRect(f*d,f*d,e/2*d,c*d-2*f*d);var g=new Image;g.src=a[this.ItemProperties.popupSprite];console.log(e,c);g.onload=function(){ctx$$module$js$inventory.drawImage(g,f*d,f*d,e/
2*d,c*d-2*f*d)}};function drawSize$$module$js$inventory(){return{width:104,height:84,boxSize:16,padding:4,scale:4}}var module$js$inventory={};module$js$inventory.default=Inventory$$module$js$inventory;var fragmentShader$$module$js$shader="\n\tvarying vec2 vUv;\n\n\tuniform float opacity;\n\tuniform sampler2D map;\n\n\tvec3 hsl2rgb(vec3 c)\n\t{\n\t\tfloat t = c.y * ((c.z < 0.5) ? c.z : (1.0 - c.z));\n\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\treturn (c.z + t) * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), 2.0*t / c.z);\n\t}\n\n\tvoid main(void)\n\t{\n\t\t/* Read a group of texels, doing a box blur */\n\n\t\tvec3 accumulator = vec3(0.0);\n\t\tvec2 dim_step = vec2(1.0/480.0) * 1.4;\n\n\t\tfor (int i = -2; i < 2; ++i) {\n\t\t\tfor (int j = -2; j < 2; ++j) {\n\t\t\t\taccumulator += texture2D(map, vUv + dim_step * vec2(i, j)).rgb;\n\t\t\t}\n\t\t}\n\n\t\tvec3 blur = accumulator / 16.0;\n\n\t\t/* Convert (RGB source) to greyscale luminance, by taking the Y\n\t\t * component of YUV (multiplying by BT.709 coefficients) */\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(blur, coefficients);\n\n\t\t/* Adjust brightness */\n\n\t\tfloat brightness = 1.1;\n\t\tgrey = clamp(grey * brightness, 0.0, 1.0);\n\n\t\t/* Posterize */\n\n\t\tfloat levels = (6.0) - 1.0;\n\t\tfloat posterized = floor((grey * levels) + 0.5) / levels;\n\n\t\t/* Increase contrast */\n\n\t\tfloat contrast = 1.4;\n\t\tfloat contrasted = clamp(contrast * (posterized - 0.5) + 0.5, 0.0, 1.0);\n\n\t\t/* Colourize! Choose a particular hue/saturation, and then pick colours\n\t\t * by setting the lightness to the calculated value above */\n\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 rgb = hsl2rgb(vec3(0.2, 0.4, contrasted));\n\t\tgl_FragColor = vec4(vec3(rgb), 1.0) * .09 + rgba * .93;\n\n\t\tfloat darkness = .5 - (rgb.r+rgb.g+rgb.b)/3.;\n\n\t\tgl_FragColor.rgb *= 1.-darkness;\n\n\t\tfloat grey2 = 0.21 * rgba.r + 0.71 * rgba.g + 0.07 * rgba.b;\n\n\t\tgl_FragColor.rgb *= grey2;\n\n\n\t\tgl_FragColor.a = opacity;\n\t}\n\n\t/*void mainx() {\n\t\tvec4 rgba = texture2D(map, vUv);\n\n\t\tvec3 coefficients = vec3(0.2126, 0.7152, 0.0722);\n\t\tfloat grey = dot(coefficients, rgba.rgb);\n\n\t\tgl_FragColor = rgba;\n\t\tgl_FragColor.a = opacity;\n\t\tgl_FragColor.r += .5;\n\t}*/\n",
module$js$shader={fragmentShader:fragmentShader$$module$js$shader};window.Micrio.prototype.forceGL=!0;var Game$$module$js$game=function(){console.log("New game!");this.hasPlayedIntroTexts=[];this.inventory=null;this.levels={};this._container=this.micrio=this.currentPopup=this.currentLevel=null;this.create=this.create.bind(this);this.init=this.init.bind(this);this.setLevel=this.setLevel.bind(this);this.onclicked=this.onclicked.bind(this);document.fonts&&document.fonts.load?document.fonts.load('10pt "Acme"').then(this.create):this.create()};
Game$$module$js$game.prototype.create=function(){this.micrio=new window.Micrio({id:"UkwTz",forceGL:!0,fragmentShader:fragmentShader$$module$js$shader,minimap:!1,loaderbar:!1,path:"https://storage.googleapis.com/micrio-dotnet/"});this._container=this.micrio.container;this._container.addEventListener("click",this.onclick.bind(this));this._container.addEventListener("mousemove",this.mousemove.bind(this));this._container.addEventListener("load",this.init)};
Game$$module$js$game.prototype.init=function(){console.log("Init game!",this.micrio);this._container.removeEventListener("load",this.init);this._container.addEventListener("metadata",this.setLevel);this._container.addEventListener("pre-metadata",this.setShader);this.inventory=new Inventory$$module$js$inventory(this);this.setLevel(this.micrio)};
Game$$module$js$game.prototype.setLevel=function(a){a=this.micrio=a.detail?a.detail:a;this.currentLevel&&this.currentLevel.deactivate();this.currentPopup&&this.currentPopup.close();this.levels[a.id]||(this.levels[a.id]=new Level$$module$js$level(this,a));this.currentLevel=this.levels[this.micrio.id];this.micrio.THREE.onClickVR=this.onclicked;this.currentLevel.activate()};
Game$$module$js$game.prototype.goto=function(a){this.currentPopup&&this.currentPopup.close();this.micrio.camera.stop();this.micrio.modules.navigator.goto(a,void 0,!0)};Game$$module$js$game.prototype.saveGame=function(){};Game$$module$js$game.prototype.loadGame=function(){};
Game$$module$js$game.prototype.onclick=function(a){if(this.micrio&&this.micrio.THREE){if(this.currentPopup){var b=this.micrio.THREE.getCast([a.clientX,a.clientY],this.currentPopup.mesh.children)[0];if(b&&b.object.onclick){this.onclicked(b);return}}if(this.inventory.opened&&(b=this.micrio.THREE.getCast([a.clientX,a.clientY],[this.inventory.mesh])[0])){this.inventory.clicked(b.uv.x,1-b.uv.y);return}if(a=this.micrio.THREE.getCast([a.clientX,a.clientY])[0])this.onclicked(a)}};
Game$$module$js$game.prototype.onclicked=function(a){if(a&&a.object)if(this.currentPopup&&a.object.onclick)a.object.onclick();else(a=a.object.marker)&&(a.link?a.open():this.currentLevel.clickedItem(a))};
Game$$module$js$game.prototype.mousemove=function(a){if(this.micrio&&this.micrio.THREE){var b=this.micrio.THREE.getCast([a.clientX,a.clientY])[0];!b&&this.currentPopup&&(b=this.micrio.THREE.getCast([a.clientX,a.clientY],this.currentPopup.mesh.children)[0],b!=this.currentPopup.hovered&&(this.currentPopup.hovered&&(this.currentPopup.hovered.object.material.opacity=.75),b&&(b.object.material.opacity=1)),this.currentPopup.hovered=b,this.micrio.camera.render());a=b&&b.object.marker;var c=this.micrio.el.classList;
this._container.title=a&&a.title||"";b?c.contains("hover")||c.add("hover"):c.contains("hover")&&c.remove("hover")}};window.game=new Game$$module$js$game;var module$js$game={};module$js$game.default=Game$$module$js$game;
